<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:p="http://primefaces.org/ui"
      xmlns:o="http://omnifaces.org/ui"
>

<ui:composition template="WEB-INF/DefaultTemplateTwoColumns.xhtml">

    <f:metadata>
        <f:viewAction action="#{backingBeanVisit.init()}" />
    </f:metadata>

    <ui:param name="active" value="Visit" />
    <ui:param name="title" value="Restaurantbesuch planen" />

    <ui:define name="titleHeader">
        <h2>#{title}</h2>
    </ui:define>



    <!--Visit Daten anlegen-->
    <ui:define name="mainContent">

        <h:form id="visitCreate">


            <h:inputHidden value="#{backingBeanVisit.current.prim}" />
            <h:inputHidden id="sizeParticipants_Actual" value="#{backingBeanVisit.sizeParticipantsForValidator}" validator="serverValidatorParticipants"/>
            <h:inputHidden id="sizeParticipants_Initial" value="#{backingBeanVisit.sizeParticipantsForValidator}" />

            <!-- Ort -->
            <p:growl id="feedbackLocationSearch" for="place" showDetail="true" keepAlive="10000"/>

            <div class="row">
                <div class="col-4">
                    <label for="place">PLZ und Ort:</label>
                </div>

                <div class="col-3">
                    <h:inputText id="zip"  value="#{backingBeanVisit.current.addressVisit.zipCode}" class="form-control" required="false" />
                </div>

                <div class="col-5">
                    <h:inputText id="place" value="#{backingBeanVisit.current.addressVisit.city}" class="form-control" required="false" >
                        <p:ajax  event="change" process="googleMapsResult" delay="1000" />
                    </h:inputText>
                </div>
            </div>
            <br/>

            <script type="text/javascript" src="https://maps.google.com/maps/api/js?sensor=true&amp;key=AIzaSyDtJoxBmEHGk8KsyyiBcynKz5NrdxnELvE"></script>
            <ui:remove>


                <!--                <div>-->
                <!--                    <p:gmap id="geoMap" widgetVar="geoMap" center="41.381542, 2.122893" zoom="1" rendered="true"-->
                <!--                            type="ROADMAP" model="#{backingBeanVisit.geoModel}" style="width:0%;height:0px">-->
                <!--                             <p:ajax event="geocode" listener="#{backingBeanVisit.onGeocode}" immediate="true" update="visitCreate:feedbackLocationSearch"/>-->
                <!--                    </p:gmap>-->
                <!--                </div>-->

            </ui:remove>

            <div style="display: block">
                <h:inputText id="googleMapsResult" value="#{backingBeanVisit.googleMapsResult}" >
                    <p:ajax  event="change" process="@this" immediate="true"  render="visitCreate:feedbackLocationSearch"/>
                </h:inputText>
            </div>


            <!-- Kulinarik -->
            <div class="row" >
                <div class="col-4">
                    <label>Kulinarik Wunsch:</label>
                </div>

                <div class="col-8">
                    <p:selectCheckboxMenu id="multiple" value="#{backingBeanVisit.culinariesArray}" label="Label"
                                          style="width:100%; !important;" converter="omnifaces.SelectItemsConverter"
                                          multiple="true"  filter="true" filterMatchMode="startsWith" >

                        <p:ajax event="change" />
                        <p:ajax event="toggleSelect" />

                        <f:selectItems value="#{backingBeanVisit.allCulinariesProxy}" style="width:100%; !important;"/>
                    </p:selectCheckboxMenu>

                </div>
            </div>
            <br/>
            <!--Memo -->
            <div class="row">
                <div class="col-4">
                    <label>Memo: </label>
                </div>

                <div class="col-8">
                    <h:inputText id="memo" value="#{backingBeanVisit.current.memo}" class="form-control" required="false" >
                    </h:inputText>
                </div>
            </div>
            <br/>

            <!-- Datum -->
            <div class="row">
                <div class="col-4">
                    <label>Datum:</label>
                </div>
                <div class="col-8">
                    <p:datePicker id="buttonbar" value="#{backingBeanVisit.current.visitingDate}" showButtonBar="true" locale="de" required="true"
                                  converterMessage="Bitte ein gültiges Datum wählen"
                                  requiredMessage="Bitte ein gültiges Datum wählen" />
                </div>
            </div>
            <br/>

            <!-- Uhrzeit -->
            <div class="row">
                <div class="col-4">
                    <label>Uhrzeit:</label>
                </div>
                <div class="col-8">
                    <p:datePicker id="time" value="#{backingBeanVisit.current.visitingTime}" timeInput="true"  pattern="HH:mm"  required="true"
                                  converterMessage="Bitte eine gültige Uhrzeit wählen"
                                  requiredMessage="Bitte eine gültige Uhrzeit wählen" />
                </div>

            </div>
            <br/>
            <!--Zeitzone -->
            <div class="row">
                <div class="col-4">
                    <label>Zeitzone:</label>
                </div>
                <div class="col-8">
                    <p:autoComplete id="fieldTimezone" dropdown="false" forceSelection="true"  autocomplete="on" required="true"
                                    value="#{backingBeanVisit.current.timezoneString}" widgetVar="widgetVarTimezone"
                                    completeMethod="#{backingBeanVisit.completeText}"
                                    scrollHeight="250" style="width: 200px !important;"
                                    requiredMessage="Bitte eine gültige Zeitzone wählen" />
                </div>
            </div>
            <br/>

            <!-- Buttons -->
            <h:commandButton action="#{backingBeanVisit.saveVisit()}"  value="Speichern und zurück" class="btn btn-success" />
            <h:commandButton action="#{backingBeanVisit.saveVisitNext()}" actionListener="#{suggestionsBean.proxyOnLoad()}" value="Speichern und weiter" class="btn btn-warning">
            </h:commandButton>
        </h:form>



    </ui:define>


    <!-- Userauswahl Liste -->
    <ui:define name="subContent">

        <h:form id="userForm">

            <p:growl id="visitCreateGrowl" showDetail="false"  />

            <p:dataTable id="dt-participants" widgetVar="dt-participants-var" var="user"  reflow="false" styleClass="products-table" stripedRows="true" size="medium"
                         style="border: 0px solid transparent; outline: 1px solid lightgrey; padding-right: 0px"
                         rows="10" paginator="false" paginatorPosition="bottom"
                         value="#{backingBeanUser.getAllUsers()}" rowKey="#{user.id}"
                         selection="#{backingBeanVisit.current.participants}" rowSelectMode="add">

                <p:ajax event="rowSelect"  update=":visitCreate:sizeParticipants_Actual" />
                <p:ajax event="rowUnselect" update=":visitCreate:sizeParticipants_Actual" />
                <p:ajax event="rowSelectCheckbox" update=":visitCreate:sizeParticipants_Actual" />
                <p:ajax event="rowUnselectCheckbox" update=":visitCreate:sizeParticipants_Actual" />
                <p:ajax event="toggleSelect" update=":visitCreate:sizeParticipants_Actual" />

                <f:facet name="header">
                    <div class="products-table-header">
                        <span style="font-weight: normal">Welche Nutzer nehmen teil?</span>
                    </div>
                </f:facet>

                <p:column headerText="Vorname" colspan="5" sortBy="#{user.firstname}" >
                    <h:outputText value="#{user.firstname}"/>
                </p:column>

                <p:column headerText="Nachname" colspan="6" sortBy="#{user.lastname}" >
                    <h:outputText value="#{user.lastname}"/>
                </p:column>

                <p:column headerText="Ort" colspan="5" sortBy="#{user.addressLiving.city}">
                    <h:outputText value="#{user.addressLiving.city}"/>
                </p:column>

                <p:column selectionMode="multiple" colspan="3" exportable="false"></p:column>


            </p:dataTable>
        </h:form>

        <!-- Skripte -->
        <script type="text/javascript">

            // document.getElementById("visitCreate:place").onblur = function() {
            //     let field = document.getElementById("visitCreate:place");
            //     let inputText = field.value;
            //     if(!inputText)
            //     {
            //         document.getElementById("visitCreate:place").blur();
            //         return;
            //     }
            //     else
            //     {
            //         document.getElementById("visitCreate:place").blur();
            //         PF('geoMap').geocode(inputText);
            //     }
            // }


            document.getElementById("visitCreate:place").onblur = function()
            {
                let fieldOrt = document.getElementById("visitCreate:place");

                let varInputText = fieldOrt.value + " " + document.getElementById("visitCreate:zip").value;
                if(!varInputText)
                {
                    // !doc.value ist true wenn nichts eingegeben wurde
                    console.log("Text war " + varInputText + ". Methode endet.");
                    document.getElementById("visitCreate:place").blur();
                    return;
                }
                else
                {
                    console.log("Text war " + varInputText + ". Geocode wird aufgerufen.");
                    //document.getElementById("visitCreate:place").blur();
                    ////////////////////////////////////////////////////////////////
                    var geocoder = new google.maps.Geocoder();
                    geocoder.geocode({'address': varInputText}, function (results, status)
                    {
                        if (status === 'OK')
                        {
                            console.log("Status war OK");
                            // map.setCenter(results[0].geometry.location);
                            // var marker = new google.maps.Marker({ map: map,  position: results[0].geometry.location });
                            let stringResult = status+"+#"+results[0].geometry.location+"+#"+results[0].formatted_address;
                            console.log("stringResult " + stringResult);


                            document.getElementById("visitCreate:googleMapsResult").value = stringResult;

                            //console.log("wert in hiden field" + document.getElementById("visitCreate:googleMapsResult").value);


                        }
                        else
                        {
                            // Wenn mann Müll eingibt, ist der Status nicht OK
                            console.log('CUSTOMIZED ERROR MESSAGE');
                        }
                    });
                }
                console.log("Skript endet.");
            }





            PrimeFaces.locales ['de'] = {
                closeText: 'Schließen',
                prevText: 'Zurück',
                nextText: 'Weiter',
                monthNames: ['Januar', 'Februar', 'März', 'April', 'Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'],
                monthNamesShort: ['Jan', 'Feb', 'Mär', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dez'],
                dayNames: ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'],
                dayNamesShort: ['Son', 'Mon', 'Die', 'Mit', 'Don', 'Fre', 'Sam'],
                dayNamesMin: ['S', 'M', 'D', 'M ', 'D', 'F ', 'S'],
                weekHeader: 'Woche',
                firstDay: 1,
                isRTL: false,
                showMonthAfterYear: false,
                yearSuffix: '',
                timeOnlyTitle: 'Nur Zeit',
                timeText: 'Zeit',
                hourText: 'Stunde',
                minuteText: 'Minute',
                secondText: 'Sekunde',
                currentText: 'Aktuelles Datum',
                ampm: false,
                month: 'Monat',
                week: 'Woche',
                day: 'Tag',
                allDayText: 'Ganzer Tag',
                today: 'Heute',
                clear: 'Löschen'
            };

            $(document).ready(function(){
                $('.input-daterange').datepicker({
                    format: 'dd-mm-yyyy',
                    autoclose: true,
                    calendarWeeks : true,
                    clearBtn: true,
                    disableTouchKeyboard: true
                });
            });

        </script>

    </ui:define>




    <ui:define name="footer">
    </ui:define>

</ui:composition>


</html>